<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YatKal - Admin Paneli</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            padding: 20px; 
            background-color: #f4f7f6; /* Daha yumuşak bir arka plan */
        }
        .log-container { 
            max-width: 1200px;
            margin: 0 auto;
        }
        h2 { 
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        
        /* YENİ KART STİLİ */
        .log-entry { 
            background: #ffffff; /* Beyaz kart */
            border: 1px solid #e0e0e0;
            border-left: 5px solid #0D47A1; /* Sol kenarda Mavi çizgi */
            padding: 16px; 
            border-radius: 8px; 
            margin-bottom: 16px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
        }
        .log-entry p {
            margin: 4px 0;
        }
        .log-entry strong {
            color: #333; /* Etiketler için koyu renk */
            min-width: 120px;
            display: inline-block;
        }
        .log-entry .header {
            font-size: 16px;
            font-weight: 600;
            color: #0D47A1; /* Mavi Başlık */
            border-bottom: 1px dashed #eee;
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        .security-info {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="log-container">
        <h2>Giriş Logları</h2>
        <div id="loglar">
            <p style="color: #999;">Sunucuya bağlanılıyor...</p>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io("/"); // Sunucuya bağlan
        const logAlani = document.getElementById("loglar");

        // --- YENİ: JSON Verisini HTML Karta Çeviren Fonksiyon ---
        function createLogCard(logData) {
            // Gelen veriyi 'güvenli' hale getir (HTML enjeksiyonunu önle)
            const safe = (str) => str.replace(/</g, "&lt;").replace(/>/g, "&gt;");

            return `
                <p class="header"><strong>Tarih:</strong> ${safe(logData.tarih)}</p>
                
                <p><strong>İsim Soyisim:</strong> ${safe(logData.isim)}</p>
                <p><strong>Telefon:</strong> ${safe(logData.telefon)}</p>
                <p><strong>Mail:</strong> ${safe(logData.mail)}</p>
                <p><strong>Form TC:</strong> ${safe(logData.form_tc)}</p>
                <p><strong>NFC TC:</strong> ${safe(logData.nfc_tc)}</p>
                <p><strong>Canlılık Testi:</strong> ${safe(logData.canlilik_testi)}</p>
                
                <div class="security-info">
                    <strong>IP Adresi:</strong> ${safe(logData.ip_adresi)}<br>
                    <strong>WiFi Adı:</strong> ${safe(logData.wifi_ssid)}<br>
                    <strong>Cihaz Modeli:</strong> ${safe(logData.cihaz_modeli)}<br>
                    <strong>Cihaz ID:</strong> ${safe(logData.cihaz_id)}
                </div>
            `;
        }
        
        function addLogToScreen(logData, enUsteEkle = true) {
            const logDiv = document.createElement("div");
            logDiv.className = "log-entry";
            logDiv.innerHTML = createLogCard(logData); // Metin yerine HTML kartı bas

            if (enUsteEkle) {
                logAlani.insertBefore(logDiv, logAlani.firstChild); // Yeni logu en üste koy
            } else {
                logAlani.appendChild(logDiv); // Geçmiş logu en alta koy
            }
        }
        // -----------------------------------------------------------

        // Bağlantı kurulduğunda "Bağlanılıyor..." yazısını temizle
        socket.on("connect", () => {
            if (logAlani.querySelector("p")) {
                logAlani.innerHTML = "";
            }
        });

        // 1. ANLIK DİNLEYİCİ: Sunucudan 'yeni' bir log (JSON) gelirse...
        socket.on("yeni_giris_bilgisi", (logData) => {
            addLogToScreen(logData, true); // Logu en üste ekle
        });

        // 2. GEÇMİŞ DİNLEYİCİ: Sayfa yüklendiğinde 'tüm geçmiş' (JSON dizisi) gelirse...
        socket.on("log_gecmisi", (tumLoglar) => {
            logAlani.innerHTML = ""; // Önce ekranı temizle
            
            // Sunucudaki dizi [Log3, Log2, Log1] (yeni en üstte) olduğu için
            // ekrana [Log3, Log2, Log1] sırasında basmalıyız.
            tumLoglar.forEach(logData => {
                addLogToScreen(logData, false); // Logları sırayla sona ekle
            });
        });
    </script>
</body>
</html>
